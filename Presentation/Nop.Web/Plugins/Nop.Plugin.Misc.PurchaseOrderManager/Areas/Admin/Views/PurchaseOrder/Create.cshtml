@model Nop.Plugin.Misc.PurchaseOrderManager.Areas.Admin.Models.PurchaseOrderModel
@{
	Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
	ViewBag.PageTitle = T("Admin.PurchaseOrders.Create").Text;
}

<form asp-controller="PurchaseOrderManager" asp-action="Create" method="post" id="create-form">
	<div class="content-header clearfix">
		<h1 class="float-left">@T("Admin.PurchaseOrders.Create")</h1>
	</div>

	<div class="content">
		<div class="form-horizontal">
			<div class="form-group row align-items-center">
				<label asp-for="SupplierId" class="col-form-label col-md-2 text-right">@T("Admin.PurchaseOrders.SelectSupplierPrompt")</label>
				<div class="col-md-6">
					<select asp-for="SupplierId" asp-items="Model.AvailableSuppliers" class="form-control" id="SupplierId">
						<option value="">@T("Admin.PurchaseOrders.SelectSupplierPrompt")</option>
					</select>
				</div>
			</div>

			<div class="form-group row">
				<div class="col-md-2 offset-md-2">
					<button type="button" id="add-product-btn" class="btn btn-primary">
						<i class="fas fa-plus"></i> @T("Admin.PurchaseOrders.AddProduct")
					</button>
				</div>
			</div>

			<!-- Selected Products Table -->
			<div id="selected-products-container" class="form-group" style="display:block;">
				<div class="card">
					<div class="card-header">
						<h5>@T("Admin.PurchaseOrders.SelectedProducts")</h5>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-bordered table-hover dataTable">
								<thead>
									<tr>
										<th>@T("Admin.Catalog.Products.Fields.Name")</th>
										<th>@T("Admin.Catalog.Products.Fields.Price")</th>
										<th>@T("Admin.Catalog.Products.Fields.Quantity")</th>
										<th>@T("Admin.Catalog.Products.Fields.LinePrice")</th>
										<th class="text-center">@T("Admin.Common.Edit")</th>
										<th class="text-center">@T("Admin.Common.Delete")</th>
									</tr>
								</thead>
								<tbody id="selected-products-body"></tbody>
								<!-- Total Line Cost Row -->
								<tfoot id="total-line-cost-row">
									<tr>
										<td colspan="3" class="text-right"><strong>@T("Admin.PurchaseOrders.TotalLineCost"):</strong></td>
										<td id="total-line-cost" colspan="2"></td>
									</tr>
								</tfoot>
							</table>
						</div>

						<!-- Save Button inside the table container with added margin -->
						<div class="text-left" style="margin-top: 20px;">
							<button type="submit" name="save" class="btn btn-primary">
								<i class="fas fa-save"></i> @T("Admin.Common.Save")
							</button>
						</div>
					</div>
				</div>
			</div>

			<div id="selected-products-inputs"></div>
		</div>
	</div>
</form>

@section Scripts {
	<script>
		let selectedProducts = [];
		let editingProductId = null;

		$(document).ready(function () {
			updateSelectedProductsUI();

			$('#SupplierId').change(function () {
				const supplierId = $(this).val();
				if (!supplierId) selectedProducts = [];
				updateSelectedProductsUI();
			});

			$('#add-product-btn').click(function () {
				const supplierId = $('#SupplierId').val();
				if (!supplierId) return;

				const width = 800;
				const height = 600;
				const left = (window.screen.width / 2) - (width / 2);
				const top = (window.screen.height / 2) - (height / 2);

				const popupWindow = window.open(
					'@Url.Action("ProductSelectionPopup", "PurchaseOrderManager")?supplierId=' + supplierId,
					'ProductSelectionPopup',
					'width=' + width + ',height=' + height + ',top=' + top + ',left=' + left
				);

				popupWindow.opener = window;
				popupWindow.parentSelectedProducts = selectedProducts;

				return false;
			});

			$('#create-form').submit(function (e) {
				if (selectedProducts.length === 0) {
					alert('@T("Admin.PurchaseOrders.SelectAtLeastOneProduct")');
					e.preventDefault();
					return false;
				}
			});
		});

		function receiveSelectedProducts(products) {
			products.forEach(product => {
				const exists = selectedProducts.some(p => p.id === product.id);
				if (!exists) {
					product.price = parseFloat(product.price || 0);
					product.quantity = 1;
					selectedProducts.push(product);
				}
			});
			$('#selected-products-container').show();
			updateSelectedProductsUI();
		}

		function editProduct(productId) {
			editingProductId = productId;
			updateSelectedProductsUI();
		}

		function updateProduct(productId) {
			const row = $('#product-row-' + productId);
			const price = parseFloat(row.find('.price-input').val());
			const quantity = parseInt(row.find('.qty-input').val());

			if (!isNaN(price) && !isNaN(quantity)) {
				const product = selectedProducts.find(p => p.id === productId);
				if (product) {
					product.price = price;
					product.quantity = quantity;
				}
			}

			editingProductId = null;
			updateSelectedProductsUI();
		}

		function cancelEdit(productId) {
			editingProductId = null;
			updateSelectedProductsUI();
		}

		function removeProduct(productId) {
			selectedProducts = selectedProducts.filter(p => p.id !== productId);
			updateSelectedProductsUI();
		}

		function updateSelectedProductsUI() {
			const tbody = $('#selected-products-body');
			const inputs = $('#selected-products-inputs');
			let totalLineCost = 0; // Initialize total line cost variable

			tbody.empty();
			inputs.empty();

			selectedProducts.forEach(product => {
				const isEditing = (editingProductId === product.id);
				const linePrice = (product.price * product.quantity).toFixed(2);
				totalLineCost += parseFloat(linePrice); // Add line price to total line cost

				const row = $(`
					<tr id="product-row-${product.id}">
						<td>${product.name}</td>
						<td>${isEditing
							? `<input type="number" class="form-control price-input" value="${product.price}" step="0.01" />`
							: product.price.toFixed(2)}</td>
						<td>${isEditing
							? `<input type="number" class="form-control qty-input" value="${product.quantity}" />`
							: product.quantity}</td>
						<td>${isEditing
							? `<input type="number" class="form-control line-price-input" value="${linePrice}" step="0.01" disabled />`
							: linePrice}</td>
						<td class="text-center">
							${isEditing
								? `<button type="button" class="btn btn-success btn-sm" onclick="updateProduct(${product.id})">
										<i class="fas fa-check"></i> @T("Admin.Common.Update")
								   </button>
								   <button type="button" class="btn btn-secondary btn-sm" onclick="cancelEdit(${product.id})">
										<i class="fas fa-times"></i> @T("Admin.Common.Cancel")
								   </button>`
								: `<button type="button" class="btn btn-info btn-sm" onclick="editProduct(${product.id})">
										<i class="fas fa-edit"></i> @T("Admin.Common.Edit")
								   </button>`}
						</td>
						<td class="text-center">
							<button type="button" class="btn btn-danger btn-sm" onclick="removeProduct(${product.id})">
								<i class="fas fa-trash"></i> @T("Admin.Common.Delete")
							</button>
						</td>
					</tr>
				`);

				tbody.append(row);

				inputs.append(`
					<input type="hidden" name="SelectedProductIds" value="${product.id}" />
					<input type="hidden" name="Quantities[${product.id}]" value="${product.quantity}" />
				`);
			});

			// Update the total line cost in the footer row
			const totalLineCostContainer = $('#total-line-cost');
			totalLineCostContainer.text(totalLineCost.toFixed(2));
		}
	</script>
}
